/*!
 porcelain
 * Version: 0.1.0 
 * Built: 2014-06-30 
 */
function Util(){}function BaseChart(a){this.element=a}function BarChart(a){BaseChart.call(this,a),this._addBarLabels=function(){var a=this,b=this.chart.select("g");b.append("g").attr("class","labels").selectAll(".label").data(this.data).enter().append("text").text(function(b){return console.log(a._formatter),void 0!==a._formatter?a._formatter(b.value):b.value}).attr("x",function(b){return a.x(b.key)+a.x.rangeBand()/2}).attr("y",function(b){return a.y(b.value)-5}).style("text-anchor","middle")},this._rotateLabel=function(){var a=this.chart.select("g");a.select(".axis.x").selectAll("g.tick text").attr("transform","rotate("+this.label_rotation+") translate(-20,15)").style("text-anchor","start")}}function HorizontalBarChart(a){BaseChart.call(this,a)}function PieChart(a){BaseChart.call(this,a),this.count=-1,this._getCentroid=function(a,b){return d3.svg.arc().outerRadius(this.radius+b).innerRadius(this.label_offset>0?this.radius+b:this.inner_radius).centroid(a)},this._getMultiplier=function(a){return a.endAngle-a.startAngle<Math.PI/180*10?(this.count++,this.offset_padding*this.count):0}}function Callout(a,b){var c=b.keyFormatter||function(a){return a.key},d=b.valueFormatter||function(a){return a.value},e=this;a.element.addEventListener("afterRender",function(f){Object.getPrototypeOf(a)==f.detail&&e.enablePointer(a,b.selector,c,d)})}var Porcelain=function(){this._chart_selector="porcelain-chartable",this._chart_class="porcelain-chart",this._chart_types={},this._charts=[],this._plugin_types={},this.init()};Porcelain.prototype.init=function(){this.constructDOMCharts()},Porcelain.prototype.addChart=function(a,b,c){return this._charts.push({chart:a,node:b,type:c}),this.addClass(a.element,this._chart_class),this.addClass(a.element,c),this._charts.length},Porcelain.prototype.addChartToRegistry=function(a,b){if(!Util.searchPrototypeChain(b.prototype,BaseChart.prototype))throw"Chart: '"+a+"' must inherit from BaseChart";if(!b.prototype.hasOwnProperty("render"))throw"Chart: '"+a+"' must implement a 'render' method";if(this._chart_types[a])throw"Chart '"+a+"' already defined. Skipping ...";var c;this.overrideRenderer(b),this._chart_types[a]=b,Object.defineProperty(this,a,{get:function(){return function(d){return c=new b(d),this.addChart(c,d,a),c}}})},Porcelain.prototype.addClass=function(a,b){a.classList?a.classList.add(b):a.className+=" "+b},Porcelain.prototype.addPluginToRegistry=function(a,b){if(this._plugin_types[a])throw"Plugin '"+a+"' already defined. Skipping ...";var c;this._plugin_types[a]=b,Object.defineProperty(this,a,{get:function(){return function(a){return c=new b(a)}}})},Porcelain.prototype.assignChartProperties=function(a,b){var c,d;if(a.getAttribute("data-capabilities")){d=JSON.parse(a.getAttribute("data-capabilities"));for(var e in d)b.capabilities[e]&&(b[e]=d[e])}for(var e in b.capabilities)c=a.getAttribute("data-"+e.replace("_","-")),c&&(b[e]=Util.parseAttribute(c,b,e))},Porcelain.prototype.constructDOMCharts=function(){for(var a,b,c,d=document.querySelectorAll("."+this._chart_selector),e=0;e<d.length;e++){a=d[e],b=a.getAttribute("data-chart-type");try{c=this[Util.titleCase(b)](a)}catch(f){return void console.warn('Chart type: "'+b+'" not found. Skipping render')}this.assignChartProperties(a,c),c.render()}},Porcelain.prototype.overrideRenderer=function(a){var b=a.prototype.render;Object.defineProperties(a.prototype,{render:{value:function(){a.prototype.hasOwnProperty("beforeRender")&&(a.prototype.beforeRender.call(this),this.element.dispatchEvent(new CustomEvent("beforeRender",{detail:a.prototype}))),this.validate(arguments,function(){b.apply(this,arguments),this.element.dispatchEvent(new CustomEvent("render",{detail:a.prototype})),a.prototype.hasOwnProperty("afterRender")&&(a.prototype.afterRender.call(this),this.element.dispatchEvent(new CustomEvent("afterRender",{detail:a.prototype})))})}}})},Porcelain.prototype.register=function(a,b){try{this.addChartToRegistry(a,b)}catch(c){console.warn(c)}},Porcelain.prototype.registerPlugin=function(a,b){try{this.addPluginToRegistry(a,b)}catch(c){console.warn(c)}},Object.defineProperties(Porcelain.prototype,{charts:{get:function(){return this._charts}},types:{get:function(){return this._chart_types}},plugins:{get:function(){return this._plugin_types}}}),window.Porcelain=new Porcelain,document.addEventListener("DOMContentLoaded",function(){Porcelain.init()}),Util.prototype.parseAttribute=function(a,b,c){var d=b.capabilities[c].type;return Util.formatType(a,d)},Util.prototype.formatType=function(a,b){switch(b){case"boolean":return"true"==a?!0:!1;case"int":return parseInt(a);case"float":return parseFloat(a);case"JSON":return JSON.parse(a);default:return a}},Util.prototype.extend=function(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a},Util.prototype.extendChart=function(a,b){a.prototype=Object.create(b.prototype),Object.defineProperties(a.prototype,{constructor:{value:a},_capabilities:{value:function(){return Util.extend({},b.prototype.capabilities)}()}})},Util.prototype.searchPrototypeChain=function(a,b){for(;"object"==typeof a&&a!=Object.prototype;)if(a=Object.getPrototypeOf(a),a==b)return!0;return!1},Util.prototype.randomColor=function(){return"#"+Math.floor(16777216*Math.random()).toString(16)},Util.prototype.titleCase=function(a){var b=a.split("-"),c="";return b.forEach(function(a){c+=a.substr(0,1).toUpperCase(),c+=a.substr(1)}),c},Util=new Util,BaseChart.prototype.update=function(){this.chart.remove(),this.render()},Object.defineProperties(BaseChart.prototype,{validate:{value:function(a,b){var c=this,d=!0;Object.keys(this.capabilities).forEach(function(a){c.capabilities[a].required&&(c[a]||(d=!1,console.warn('Required capability "'+a+'" not set, skipping render')))}),d&&b.apply(this,a)}},_activatePlugins:{value:function(a){for(var b in a)Porcelain.plugins[b]?(a[b].instance=new Porcelain.plugins[b](this,a[b]),Object.defineProperty(this,b,{value:a[b].instance})):console.warn('Plugin "'+b+'" not registered with Porcelain, skipping plugin initialization')}},_capabilities:{writable:!0,value:{}},capabilities:{get:function(){return this._capabilities}},chart:{get:function(){return this._chart},set:function(a){this._chart=a},enumerable:!1},defineCapability:{value:function(a,b){var c=b.descriptor.defined_in.prototype;c._capabilities[a]=b.descriptor,Object.defineProperty(c,"_"+a,{writable:!0,enumerable:!1,value:b.descriptor.default}),Object.defineProperty(c,a,b.property)}},_getDimension:{value:function(a,b){var c=b[a.toLowerCase()],d=this._element["offset"+a];switch(typeof c){case"undefined":c=d;break;case"string":c=c.match("%")?d*(parseInt(c.replace("%",""))/100):d;break;case"number":}return c}}}),BaseChart.prototype.defineCapability("data",{property:{get:function(){return this._data},set:function(a){this._data="string"==typeof a?JSON.parse(a):a},enumerable:!0},descriptor:{defined_in:BaseChart,description:"Data passed into the chart",required:!0,type:"array"}}),BaseChart.prototype.defineCapability("element",{property:{get:function(){return this._element},set:function(a){this._element="string"==typeof a?document.querySelector(a):a},enumerable:!0},descriptor:{defined_in:BaseChart,description:"Element into which to draw the chart. The element passed is either a selector string or a DOM element reference",required:!0,type:"string"}}),BaseChart.prototype.defineCapability("formatter",{property:{get:function(){return this._formatter},set:function(a){this._formatter=d3.format(a)},enumerable:!0},descriptor:{defined_in:BaseChart,description:"Formatter function for labels.",required:!1,type:"function"}}),BaseChart.prototype.defineCapability("margins",{property:{get:function(){return this._margins},set:function(a){this._margins=a},enumerable:!0},descriptor:{defined_in:BaseChart,description:'Sets the margins between the chart and the containing dom element. Accepts a object with "top", "right", "bottom" and "left" properties.',"default":{top:30,right:30,bottom:30,left:30},required:!0,type:"object"}}),BaseChart.prototype.defineCapability("plugins",{property:{get:function(){return this._plugins},set:function(a){this._activatePlugins(a),this._plugins=a},enumerable:!0},descriptor:{defined_in:BaseChart,description:"Attaches the chart instance to the plugin passing options.","default":{},required:!1,type:"object"}}),BaseChart.prototype.defineCapability("size",{property:{get:function(){return{width:this._getDimension("Width",this._size),height:this._getDimension("Height",this._size)}},set:function(a){this._size=a},enumerable:!0},descriptor:{defined_in:BaseChart,description:'Sets the width and height of the chart. Accepts a object with "width" and "height" properties or a string "auto", which sets dimensions to that of the prentent element.',"default":{},required:!0,type:"object"}}),BaseChart.prototype.defineCapability("theme",{property:{get:function(){return this._theme},set:function(a){this._theme=a,this._domain=[],this._range=[];for(var b in a)this._domain.push(b),this._range.push(a[b])},enumerable:!0},descriptor:{defined_in:BaseChart,description:"Color-set for charted data.","default":{domain:[],range:[Util.randomColor(),Util.randomColor(),Util.randomColor(),Util.randomColor()],name:{}},required:!1,type:"object"}}),Util.extendChart(BarChart,BaseChart),BarChart.prototype.beforeRender=function(){this.width=this.size.width-this.margins.left-this.margins.right,this.height=this.size.height-this.margins.top-this.margins.bottom,this.x=d3.scale.ordinal().rangeRoundBands([0,this.width],.1),this.y=d3.scale.linear().range([this.height,0]),this.xAxis=d3.svg.axis().scale(this.x).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.y).orient("left"),this._formatter&&this.yAxis.tickFormat(this._formatter),this.chart=d3.select(this.element).append("svg").attr("width",this.width+this.margins.left+this.margins.right).attr("height",this.height+this.margins.top+this.margins.bottom),this.chart.append("g").attr("transform","translate("+this.margins.left+","+this.margins.top+")"),this.x.domain(this.data.map(function(a){return a.key})),this.y.domain([0,d3.max(this.data,function(a){return a.value})]),this.color=d3.scale.ordinal().domain(this._domain).range(this._range)},BarChart.prototype.render=function(){var a=this,b=this.chart.select("g");b.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(this.xAxis),b.append("g").attr("class","y axis").call(this.yAxis),b.append("g").attr("class","bars").selectAll(".bar").data(this.data).enter().append("rect").attr("class","bar").attr("x",function(b){return a.x(b.key)}).attr("y",function(b){return a.y(b.value)}).attr("height",function(b){return a.height-a.y(b.value)}).attr("width",this.x.rangeBand()).style("fill",function(b){return a.color(b.key)})},BarChart.prototype.afterRender=function(){this.labels&&this._addBarLabels(),0!==this.label_rotation&&this._rotateLabel()},BarChart.prototype.defineCapability("labels",{property:{get:function(){return this._labels},set:function(a){this._labels=a},enumerable:!0},descriptor:{defined_in:BarChart,description:"Data labels at the top of each bar","default":!1,required:!1,type:"boolean"}}),BarChart.prototype.defineCapability("label_rotation",{property:{get:function(){return this._label_rotation},set:function(a){this._label_rotation=a},enumerable:!0},descriptor:{defined_in:BarChart,description:"Degrees of which to rotate the labels on the x axis","default":0,required:!1,type:"number"}}),Porcelain.register("BarChart",BarChart),Util.extendChart(HorizontalBarChart,BaseChart),HorizontalBarChart.prototype.beforeRender=function(){var a=this;this.labels=this.data.map(function(a){return a.key}),this.layers=d3.layout.stack()(d3.range(this.categories.length).map(function(b){for(var c=[],d=0;d<a.data.length;++d)c[d]={x:d,y:a.data[d][a.categories[b]],layer:b+1};return c})),this.yGroupMax=d3.max(this.layers,function(a){return d3.max(a,function(a){return a.y})}),this.yStackMax=d3.max(this.layers,function(a){return d3.max(a,function(a){return a.y0+a.y})}),this.width=this.size.width-this.margins.left-this.margins.right,this.height=this.size.height-this.margins.top-this.margins.bottom,this.x=d3.scale.linear().domain([0,this.yStackMax]).range([0,this.width]),this.y=d3.scale.ordinal().domain(d3.range(this.data.length)).rangeRoundBands([2,this.height],.3),this.color=d3.scale.ordinal().domain(this.categories).range(this._range),this.chart=d3.select(this.element).append("svg").attr("width",this.width+this.margins.left).attr("height",this.height+this.margins.top+this.margins.bottom),this.chart.append("g").attr("transform","translate("+this.margins.left+","+this.margins.top+")")},HorizontalBarChart.prototype.render=function(){var a=this,b=this.chart.select("g").selectAll(".layer").data(this.layers).enter().append("g").attr("class","layer").style("fill",function(b,c){return a.color(a.categories[c])});b.selectAll("rect").data(function(a){return a}).enter().append("rect").attr("y",function(b){return a.y(b.x)}).attr("x",function(b){return a.x(b.y0)}).attr("height",this.y.rangeBand()).attr("width",function(b){return a.x(b.y)}).attr("class","split-bar");var c=d3.svg.axis().tickSize(1).tickFormat(function(a){return a+"%"}).scale(this.x);this.chart.append("g").attr("class","x axis").attr("transform","translate("+this.margins.left+", "+this.margins.top+this.height+")").call(c);var d=d3.svg.axis().scale(this.y).tickSize(1).tickPadding(6).tickFormat(function(b){return a.labels[b]}).orient("right"),e=this.chart.append("g").attr("class","y axis").attr("transform","translate("+this.margins.left+", 0)").call(d);e.selectAll(".tick").selectAll("text").attr("transform","translate(0,"+(this.y.rangeBand()/3+this.y.rangeBand()/3)+")")},HorizontalBarChart.prototype.defineCapability("categories",{property:{get:function(){return this._categories},set:function(a){this._categories=a},enumerable:!0},descriptor:{defined_in:HorizontalBarChart,description:"Array of keys of the data objects which to plot as segments","default":[],required:!0,type:"JSON"}}),Porcelain.register("HorizontalBarChart",HorizontalBarChart),Util.extendChart(PieChart,BaseChart),PieChart.prototype.beforeRender=function(){this.data.sort(function(a,b){return d3.descending(a.value,b.value)})},PieChart.prototype.render=function(){var a=this,b=10,c=d3.svg.arc().outerRadius(this.radius).innerRadius(this.inner_radius),d=d3.scale.ordinal().domain(this._domain).range(this._range),e=d3.layout.pie().sort(null).value(function(a){return a.value});this.chart=d3.select(this.element).append("svg").attr("width",this.size.width).attr("height",this.size.height);var f=this.chart.append("g").attr("transform","translate("+this.size.width/2+","+this.size.height/2+")"),g=f.selectAll(".pie-slice").data(e(this.data)).enter().append("g").attr("class","pie-slice");g.append("path").attr("d",c).style("fill",function(a){return d(a.data.key)}),g.append("text").attr("transform",function(b,c){var d=a._getCentroid(b,a.label_offset+a._getMultiplier(b,c));return"translate("+d+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(a){return a.data.key}),g.append("path").attr("class","pie-callout").attr("d",function(c,d){var e=a._getCentroid(c,a.label_offset-b),f=a._getCentroid(c,b,d);return a.label_offset>0?d3.svg.line()([f,e]):void 0})},PieChart.prototype.defineCapability("radius",{property:{get:function(){return this._radius},set:function(a){this._radius=a},enumerable:!0},descriptor:{defined_in:PieChart,description:"Outsize radius of the pie chart","default":100,required:!1,type:"int"}}),PieChart.prototype.defineCapability("inner_radius",{property:{get:function(){return this._inner_radius},set:function(a){this._inner_radius=a},enumerable:!0},descriptor:{defined_in:PieChart,description:"Inside radius of the chart","default":0,required:!1,type:"int"}}),PieChart.prototype.defineCapability("label_offset",{property:{get:function(){return this._label_offset},set:function(a){this._label_offset=a},enumerable:!0},descriptor:{defined_in:PieChart,description:"Measure of how far outside chart to render externalLabels labels","default":0,required:!1,type:"int"}}),PieChart.prototype.defineCapability("offset_padding",{property:{get:function(){return this._offset_padding},set:function(a){this._offset_padding=a},enumerable:!0},descriptor:{defined_in:PieChart,description:"Padding between line and label","default":15,required:!1,type:"int"}}),Porcelain.register("PieChart",PieChart),Callout.prototype.drawPointer=function(a,b,c,d,e){d=Util.titleCase(d);var f=70,g=45,h=10,i=11,j=d3.select(a.element).select("svg").append("g").attr("class","callout").style("opacity",0),k=j.append("rect").attr("class","pointer").attr("height",g),l=j.append("text").attr("class","callout-title").text(d).attr("x",h),f=Math.max(l[0][0].getBoundingClientRect().width+2*h,f),m=b<=a.size.width/2?0:f,n=c<=a.size.height/2?2*g:0,o=f/2-h+","+g+" "+ +parseInt(m)+","+parseInt(0-n+2*g)+" "+parseInt(f/2+h)+","+g;k.attr("width",f).attr("x",0).attr("y",n/2),j.append("polygon").attr("points",o),l.attr("y",i+h+n/2),j.append("text").text(e).attr("x",h).attr("y",2*i+h+2+n/2),j.attr("transform","translate("+parseInt(b-m)+", "+parseInt(c-(0-n+2*g))+")").transition().duration(75).ease("exp").style("opacity",1)},Callout.prototype.removePointer=function(){d3.selectAll(".callout").transition().duration(75).ease("exp").style("opacity",0).remove()},Callout.prototype.enablePointer=function(a,b,c,d){var e=this;a.chart.selectAll(b).each(function(b){this.addEventListener("mouseover",function(f){e.pointer_timeout=setTimeout(function(){e.drawPointer(a,f.offsetX,f.offsetY,c(b),d(b))},100)}),this.addEventListener("mouseout",function(){clearTimeout(e.pointer_timeout),e.removePointer()})})},Porcelain.registerPlugin("Callout",Callout);